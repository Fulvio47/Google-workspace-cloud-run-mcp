import { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { ResourceTemplate } from "@modelcontextprotocol/sdk/common/resource.js";
import { SSEServerTransport } from "@modelcontextprotocol/sdk/server/sse.js";
import express from "express";
import { google } from 'googleapis';
import { z } from "zod";

// 1. Initialize the MCP Server
const server = new McpServer({
  name: "MasterWorkspaceAgent",
  version: "1.0.0",
});

// 2. Resilient Google Auth (Uses Service Account automatically on Cloud Run)
const auth = new google.auth.GoogleAuth({
  scopes: [
    'https://www.googleapis.com/auth/documents',
    'https://www.googleapis.com/auth/spreadsheets',
    'https://www.googleapis.com/auth/drive.readonly'
  ],
});

// --- TOOL: READ GOOGLE DOC (Aggregated Logic) ---
server.tool(
  "read_google_doc",
  { documentId: z.string().describe("The ID of the Google Doc to read") },
  async ({ documentId }) => {
    try {
      const docs = google.docs({ version: 'v1', auth });
      const res = await docs.documents.get({ documentId });
      let content = "";
      res.data.body.content.forEach(item => {
        if (item.paragraph) {
          item.paragraph.elements.forEach(el => {
            if (el.textRun) content += el.textRun.content;
          });
        }
      });
      return { content: [{ type: "text", text: content }] };
    } catch (error) {
      return { content: [{ type: "text", text: `Error: ${error.message}` }], isError: true };
    }
  }
);

// --- TOOL: READ SHEETS (Aggregated Logic) ---
server.tool(
  "read_spreadsheet",
  { 
    spreadsheetId: z.string().describe("The ID of the spreadsheet"),
    range: z.string().describe("The range to read (e.g. 'Sheet1!A1:D10')") 
  },
  async ({ spreadsheetId, range }) => {
    try {
      const sheets = google.sheets({ version: 'v4', auth });
      const res = await sheets.spreadsheets.values.get({ spreadsheetId, range });
      const rows = res.data.values;
      return { content: [{ type: "text", text: JSON.stringify(rows, null, 2) }] };
    } catch (error) {
      return { content: [{ type: "text", text: `Error: ${error.message}` }], isError: true };
    }
  }
);

// --- TOOL: SEARCH DRIVE (Aggregated Logic) ---
server.tool(
  "search_drive",
  { query: z.string().describe("Google Drive search query (e.g. 'name contains \"Invoice\"')") },
  async ({ query }) => {
    try {
      const drive = google.drive({ version: 'v3', auth });
      const res = await drive.files.list({ q: query, fields: 'files(id, name, mimeType)' });
      return { content: [{ type: "text", text: JSON.stringify(res.data.files, null, 2) }] };
    } catch (error) {
      return { content: [{ type: "text", text: `Error: ${error.message}` }], isError: true };
    }
  }
);

// 3. Set up the Cloud Run Express Server (SSE Transport)
const app = express();
let transport;

app.get("/sse", async (req, res) => {
  console.log("New SSE connection from device");
  transport = new SSEServerTransport("/messages", res);
  await server.connect(transport);
});

app.post("/messages", async (req, res) => {
  if (transport) {
    await transport.handlePostMessage(req, res);
  } else {
    res.status(400).send("No active SSE session");
  }
});

const PORT = process.env.PORT || 8080;
app.listen(PORT, () => {
  console.log(`Master Agent is live on port ${PORT}`);
});
